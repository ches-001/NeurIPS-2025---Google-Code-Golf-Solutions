p=lambda d,t=7,E=enumerate:-t*d or p([[[c:=C[i],3,a:=[*r[j-(j>0):j+2],*C[i-(i>0):i+2]].count][a(8)+a(3)>1==c]for j,C in E(zip(*d))]for i,r in E(d)],t-1)